<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>1/1024 ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0c0c" />
  <style>
    :root{
      --bg:#0c0c0c; --fg:#f5f5f5; --muted:#bdbdbd;
      --card:#111; --border:#232323;
      --accent:#2dd4bf; --danger:#ef4444; --gold:#ffe08a;
      --glow: 0 0 40px rgba(45,212,191,.25), 0 0 80px rgba(45,212,191,.15);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;}
    .app{ min-height:100svh; display:grid; grid-template-rows:auto 1fr auto;
      gap:12px; padding: calc(env(safe-area-inset-top) + 12px) 14px calc(env(safe-area-inset-bottom) + 14px); user-select:none; touch-action:manipulation;}

    /* HUD */
    .hud{ display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center; font-variant-numeric:tabular-nums; }
    .title{ font-weight:800; letter-spacing:.02em; }
    .chip{ border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:14px; color:var(--muted); white-space:nowrap; }

    /* ä¸­å¤®è¡¨ç¤º */
    .center{ display:grid; place-items:center; text-align:center; gap:10px; }
    .prob{ font-size: clamp(32px, 18vw, 124px); font-weight:900; letter-spacing:.02em; line-height:1.05; }
    .info{ color:var(--muted); font-size: clamp(13px, 4.5vw, 18px); }
    .goal{ color:var(--muted); font-size: clamp(12px, 4vw, 16px); }

    /* å·¨å¤§ãƒœã‚¿ãƒ³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã¯ã€Œã‚¿ãƒƒãƒ—ã€ã ã‘ï¼‰ */
    .bigBtn{
      width:100%; height:min(60vh,60svh);
      border-radius:20px; border:2px solid var(--border);
      background:
        radial-gradient(180% 140% at 80% -10%, #252525 0%, #181818 40%, #131313 70%, #101010 100%);
      color:var(--fg); display:grid; place-items:center;
      font-size: clamp(28px, 8vw, 44px); font-weight:900; letter-spacing:.08em; text-transform: none;
      box-shadow: 0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
      transition: transform .02s ease, filter .08s ease;
      cursor:pointer;
    }
    .bigBtn:active{ transform: translateY(1px) scale(.998); filter:brightness(1.02); }

    /* ä¸‹éƒ¨æ“ä½œ */
    .footer{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
    .btn{ border:1px solid var(--border); background:#131313; color:var(--fg); padding:10px 14px; border-radius:12px; font-weight:700; font-size:14px; cursor:pointer; }
    .btn:active{ transform: translateY(1px); }

    /* ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º */
    .flash-ok{ animation: ok 160ms ease; }  .flash-ng{ animation: ng 180ms ease; }
    @keyframes ok{ 50%{ box-shadow:0 0 0 6px rgba(45,212,191,.22), 0 0 60px 10px rgba(45,212,191,.18);} }
    @keyframes ng{ 50%{ box-shadow:0 0 0 6px rgba(239,68,68,.22), 0 0 60px 10px rgba(239,68,68,.18);} }

    /* å‹åˆ©ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚´ãƒ¼ã‚¸ãƒ£ã‚¹ï¼‰ */
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; }
    .overlay.show{ display:flex; }
    .backdrop{
      position:absolute; inset:0;
      background: radial-gradient(100% 130% at 50% 0%, rgba(0,0,0,.3), rgba(0,0,0,.85)),
                  conic-gradient(from 180deg at 50% 50%, #0b132b, #1c2541, #3a506b, #5bc0be, #a5ffd6, #0b132b);
      filter:saturate(1.2) brightness(.9);
    }
    .modal{
      position:relative; z-index:1;
      width:min(780px, 92vw);
      background: linear-gradient(180deg, rgba(16,16,16,.9), rgba(10,10,10,.9));
      border:1px solid rgba(255,255,255,.08);
      border-radius:20px; padding:18px;
      text-align:center; box-shadow: 0 40px 120px rgba(0,0,0,.6), 0 0 120px rgba(255,255,255,.08) inset;
    }
    .trophy{
      font-size: clamp(26px, 8vw, 36px);
      background: linear-gradient(90deg, #fff, #ffe08a, #fff);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 0 20px rgba(255,224,138,.15);
      letter-spacing:.02em; font-weight:900;
      animation: shimmer 4s linear infinite;
    }
    @keyframes shimmer{ 0%{filter:hue-rotate(0)} 100%{filter:hue-rotate(360deg)} }
    .stats{ color:var(--muted); margin:6px 0 10px; font-variant-numeric:tabular-nums; }
    .actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }

    /* ç´™å¹é›ªCanvas */
    canvas.fx{ position:absolute; inset:0; pointer-events:none; z-index:0; filter: drop-shadow(0 4px 10px rgba(0,0,0,.4)); }

    /* å°ã•ãªèª¬æ˜æ  */
    details{ margin-top:10px; border:1px solid var(--border); border-radius:12px; padding:10px 12px; color:var(--muted); }
    summary{ cursor:pointer; color:var(--fg); font-weight:700; }
    code{ background:#151515; padding:1px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- HUD -->
    <div class="hud">
      <div class="title">1/1024 ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
      <div class="chip" id="globalTaps">ç·ã‚¿ãƒƒãƒ—: â€”</div>
      <div class="chip" id="online">åŒæ™‚ãƒ—ãƒ¬ã‚¤: â€”</div>
    </div>

    <!-- ä¸­å¤®è¡¨ç¤º -->
    <div class="center">
      <div class="prob" id="prob">1 / 2</div>
      <div class="info" id="info">é€£ç¶šæˆåŠŸ: 0ï½œç¾åœ¨ã®ä¸€ç™ºç¢ºç‡: 1/2</div>
      <div class="goal" id="goal">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: 1/1024ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰</div>

      <button class="bigBtn" id="tryBtn" aria-label="ã‚¿ãƒƒãƒ—">ã‚¿ãƒƒãƒ—</button>
      <div class="info" id="best">è‡ªå·±ãƒ™ã‚¹ãƒˆ: 1/2</div>
    </div>

    <!-- ä¸‹éƒ¨æ“ä½œ -->
    <div class="footer">
      <button class="btn" id="resetBtn">â†» ãƒªã‚»ãƒƒãƒˆ</button>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="soundBtn">ğŸ”Š åŠ¹æœéŸ³: ON</button>
        <button class="btn" id="vibeBtn">ğŸ“³ ãƒã‚¤ãƒ–: ON</button>
      </div>
    </div>
  </div>

  <!-- 1/1024 ã‚¯ãƒªã‚¢ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="overlay" id="winMain">
    <div class="backdrop"></div>
    <canvas class="fx" id="fxMain"></canvas>
    <div class="modal">
      <div class="trophy">CLEAR! 1/1024 é”æˆ</div>
      <div class="stats" id="winMainStats">ç·ã‚¿ãƒƒãƒ—: 0ï½œé€£ç¶šæˆåŠŸ: 10</div>
      <div class="actions">
        <button class="btn" id="goBonus">ğŸ¯ ç¶šã‘ã¦ 1/4096 ã¸</button>
        <button class="btn" id="shareMain">ğŸ”— çµæœã‚’å…±æœ‰</button>
      </div>
      <details>
        <summary>åˆ¤å®šã®æ ¹æ‹ </summary>
        <p>æˆåŠŸåˆ¤å®šã¯ <code>crypto.getRandomValues</code> ã§ç”Ÿæˆã—ãŸä¸€æ§˜32bitæ•´æ•° <code>X</code> ã«å¯¾ã—ã€Œ<code>X &lt; 2Â³Â¹</code>ã€ã‚’æˆåŠŸã¨ã™ã‚‹ â†’ 1/2 ãŒå³å¯†ã€‚é€£ç¶š10å›æˆåŠŸã§ 1/1024 = (1/2)Â¹â°ã€‚12å›ã¾ã§ç¶šã‘ã‚Œã° 1/4096 ã ã€‚</p>
      </details>
    </div>
  </div>

  <!-- 1/4096 ã‚¯ãƒªã‚¢ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="overlay" id="winUltra">
    <div class="backdrop"></div>
    <canvas class="fx" id="fxUltra"></canvas>
    <div class="modal">
      <div class="trophy">ULTRA CLEAR! 1/4096 é”æˆ</div>
      <div class="stats" id="winUltraStats">ç·ã‚¿ãƒƒãƒ—: 0ï½œé€£ç¶šæˆåŠŸ: 12</div>
      <div class="actions">
        <button class="btn" id="again">â†º ã‚‚ã†ä¸€åº¦ï¼ˆæœ€åˆã‹ã‚‰ï¼‰</button>
        <button class="btn" id="shareUltra">ğŸ”— çµæœã‚’å…±æœ‰</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* ====== å®šæ•° ====== */
    const TARGET_MAIN = 10;   // 1/1024
    const TARGET_BONUS = 12;  // 1/4096
    const BTN = document.getElementById('tryBtn');

    /* ====== çŠ¶æ…‹ ====== */
    let attempts = 0;
    let streak = 0;
    let bestPow = Number(localStorage.getItem('bestPow') || 1); // åˆ°é”ã—ãŸæœ€å¤§æŒ‡æ•°ï¼ˆ= æœ€å°ç¢ºç‡ã®æ®µï¼‰ 1..12
    let soundOn = (localStorage.getItem('soundOn') ?? '1') === '1';
    let vibeOn  = (localStorage.getItem('vibeOn')  ?? '1') === '1';
    let inBonus = false; // ãƒ¡ã‚¤ãƒ³ã‚’è¶…ãˆãŸã‚‰ true

    /* ====== DOM ====== */
    const probEl  = document.getElementById('prob');
    const infoEl  = document.getElementById('info');
    const goalEl  = document.getElementById('goal');
    const bestEl  = document.getElementById('best');
    const tapsEl  = document.getElementById('globalTaps');
    const onlineEl= document.getElementById('online');

    const resetBtn= document.getElementById('resetBtn');
    const soundBtn= document.getElementById('soundBtn');
    const vibeBtn = document.getElementById('vibeBtn');

    const winMain = document.getElementById('winMain');
    const winMainStats = document.getElementById('winMainStats');
    const goBonus = document.getElementById('goBonus');
    const shareMain = document.getElementById('shareMain');
    const fxMain = document.getElementById('fxMain');

    const winUltra = document.getElementById('winUltra');
    const winUltraStats = document.getElementById('winUltraStats');
    const again = document.getElementById('again');
    const shareUltra = document.getElementById('shareUltra');
    const fxUltra = document.getElementById('fxUltra');

    /* ====== ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª ====== */
    let audioCtx = null;
    function ensureAudio(){ if(!soundOn) return; if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } catch(e){ audioCtx=null; } } }
    function beep(freq=880, ms=80, type='sine'){
      if(!soundOn || !audioCtx) return;
      const t0 = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = type; osc.frequency.setValueAtTime(freq, t0);
      osc.connect(g).connect(audioCtx.destination);
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.25, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);
      osc.start(t0); osc.stop(t0 + ms/1000 + 0.02);
    }

    /* ====== ä¹±æ•°ï¼ˆå³å¯†ãª1/2ï¼‰ ====== */
    function fairCoin(){
      if (window.crypto && crypto.getRandomValues){
        const a = new Uint32Array(1); crypto.getRandomValues(a);
        return (a[0] >>> 0) < 0x80000000; // 2^31
      }
      return Math.random() < 0.5; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    }

    /* ====== UI æ›´æ–° ====== */
    const pow2 = n => 2 ** n;
    function updateUI(){
      const target = inBonus ? TARGET_BONUS : TARGET_MAIN;
      const nextPow = Math.min(streak + 1, target);
      const denom = pow2(nextPow);
      probEl.textContent = `1 / ${denom}`;
      infoEl.textContent = `é€£ç¶šæˆåŠŸ: ${streak}ï½œç¾åœ¨ã®ä¸€ç™ºç¢ºç‡: 1/${denom}`;
      goalEl.textContent = `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${inBonus ? '1/4096ï¼ˆãƒœãƒ¼ãƒŠã‚¹ï¼‰' : '1/1024ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰'}`;
      bestEl.textContent = `è‡ªå·±ãƒ™ã‚¹ãƒˆ: 1/${pow2(Math.max(bestPow,1))}`;
      soundBtn.textContent = `ğŸ”Š åŠ¹æœéŸ³: ${soundOn ? 'ON' : 'OFF'}`;
      vibeBtn.textContent  = `ğŸ“³ ãƒã‚¤ãƒ–: ${vibeOn ? 'ON' : 'OFF'}`;
      document.title = (streak>0?`é€£ç¶š${streak} â–¶ `:'') + '1/1024 ãƒãƒ£ãƒ¬ãƒ³ã‚¸';
    }
    function flash(ok){ BTN.classList.remove('flash-ok','flash-ng'); void BTN.offsetWidth; BTN.classList.add(ok?'flash-ok':'flash-ng'); }

    /* ====== 1å›åˆ¤å®š ====== */
    function judgeOnce(){
      attempts++;
      ensureAudio();
      incrementGlobalTapCount(); // ã‚°ãƒ­ãƒ¼ãƒãƒ«ç·ã‚¿ãƒƒãƒ—ã‚’+1ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã®ã¿ï¼‰

      const ok = fairCoin();
      if(ok){
        streak++;
        if(vibeOn && navigator.vibrate) navigator.vibrate(20);
        beep(900 + streak*12, 70, 'triangle');
        flash(true);

        if(!inBonus && streak>=TARGET_MAIN){
          bestPow = Math.max(bestPow, TARGET_MAIN);
          localStorage.setItem('bestPow', String(bestPow));
          showWinMain();
          updateUI();
          return;
        }
        if(inBonus && streak>=TARGET_BONUS){
          bestPow = Math.max(bestPow, TARGET_BONUS);
          localStorage.setItem('bestPow', String(bestPow));
          showWinUltra();
          updateUI();
          return;
        }
      }else{
        if(vibeOn && navigator.vibrate) navigator.vibrate([12,35,90]);
        beep(180, 120, 'sawtooth');
        flash(false);
        streak = 0;
      }
      bestPow = Math.max(bestPow, Math.min(streak, TARGET_BONUS));
      localStorage.setItem('bestPow', String(bestPow));
      updateUI();
    }

    /* ====== å‹åˆ©æ¼”å‡º ====== */
    function confetti(canvas, durationMs=4200, count=220){
      const ctx = canvas.getContext('2d');
      const {width:W, height:H} = canvas.getBoundingClientRect();
      canvas.width = W * devicePixelRatio; canvas.height = H * devicePixelRatio; ctx.scale(devicePixelRatio, devicePixelRatio);
      const pieces = Array.from({length:count}, () => ({
        x: Math.random()*W, y: -20 - Math.random()*H,
        w: 6+Math.random()*7, h: 10+Math.random()*14,
        vy: 2+Math.random()*3, vx:(Math.random()-.5)*1.2, rot:Math.random()*Math.PI, vr:(Math.random()-.5)*0.2,
      }));
      const colors = ['#FF6B6B','#FFD93D','#6BCB77','#4D96FF','#B892FF','#F6C177','#2DD4BF','#E879F9'];
      let start = performance.now();
      function frame(t){
        const elapsed = t - start;
        ctx.clearRect(0,0,W,H);
        for(const p of pieces){
          p.x += p.vx; p.y += p.vy; p.rot += p.vr;
          if(p.y > H+40) { p.y = -20; p.x = Math.random()*W; }
          ctx.save();
          ctx.translate(p.x,p.y); ctx.rotate(p.rot);
          ctx.fillStyle = colors[(p.x^p.y + p.w|0) % colors.length];
          ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          ctx.restore();
        }
        if(elapsed < durationMs) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }
    function showWinMain(){
      winMainStats.textContent = `ç·ã‚¿ãƒƒãƒ—: ${attempts}ï½œé€£ç¶šæˆåŠŸ: ${streak}`;
      winMain.classList.add('show');
      confetti(fxMain);
    }
    function showWinUltra(){
      winUltraStats.textContent = `ç·ã‚¿ãƒƒãƒ—: ${attempts}ï½œé€£ç¶šæˆåŠŸ: ${streak}`;
      winUltra.classList.add('show');
      confetti(fxUltra, 5200, 300);
    }

    /* ====== ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ====== */
    BTN.addEventListener('pointerdown', e => { e.preventDefault(); judgeOnce(); }, {passive:false});
    resetBtn.addEventListener('click', ()=>{ attempts=0; streak=0; inBonus=false; updateUI(); });
    soundBtn.addEventListener('click', ()=>{ soundOn=!soundOn; localStorage.setItem('soundOn', soundOn?'1':'0'); if(soundOn) ensureAudio(); updateUI(); });
    vibeBtn.addEventListener('click', ()=>{ vibeOn=!vibeOn; localStorage.setItem('vibeOn', vibeOn?'1':'0'); updateUI(); });

    goBonus.addEventListener('click', ()=>{ winMain.classList.remove('show'); inBonus=true; updateUI(); });
    again.addEventListener('click', ()=>{ winUltra.classList.remove('show'); attempts=0; streak=0; inBonus=false; updateUI(); });

    async function shareText(text){
      try{
        if(navigator.share){ await navigator.share({text, url: location.href}); }
        else{ await navigator.clipboard.writeText(text + ' ' + location.href); }
      }catch(_){ /* noop */ }
    }
    shareMain.addEventListener('click', ()=> shareText(`1/1024 ã‚¯ãƒªã‚¢ï¼é€£ç¶š${streak}å›`));
    shareUltra.addEventListener('click', ()=> shareText(`1/4096 ã‚¯ãƒªã‚¢ï¼é€£ç¶š${streak}å›`));

    /* ====== Firebaseï¼ˆCDN ESM, åŒ¿åAuth + Realtime Databaseï¼‰ ====== */
    let db=null, myUID=null, onlineCountUnsub=null, tapsUnsub=null;

    async function initFirebase(){
      // è‡ªå‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã‚’ã“ã“ã«è²¼ã‚‹ï¼ˆFirebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ« > ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®è¨­å®šï¼‰
      const firebaseConfig = {
        // TODO: ã“ã“ã«è‡ªåˆ†ã® Firebase è¨­å®šã‚’æ›¸ãï¼ˆapiKey, authDomain, databaseURL, projectId, appId ãªã©ï¼‰
        // ä¾‹:
        // apiKey: "AIzaSy....",
        // authDomain: "yourapp.firebaseapp.com",
        // databaseURL: "https://yourapp-default-rtdb.asia-southeast1.firebasedatabase.app",
        // projectId: "yourapp",
        // appId: "1:1234567890:web:abcd..."
      };
      // è¨­å®šæœªå…¥åŠ›ãªã‚‰ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã¯ã‚¹ã‚­ãƒƒãƒ—
      if(!firebaseConfig || !firebaseConfig.apiKey){ return; }

      try{
        const [{ initializeApp }, { getAuth, signInAnonymously, onAuthStateChanged }, { getDatabase, ref, onValue, push, set, onDisconnect, serverTimestamp, runTransaction }] =
          await Promise.all([
            import('https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js'),
            import('https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js'),
            import('https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js'),
          ]);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        db = getDatabase(app);

        // åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³
        await signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
          if(!user) return;
          myUID = user.uid;
          setupPresence();
          subscribeGlobalTaps();
        });

        // presence è¨­å®š
        function setupPresence(){
          const connectedRef = ref(db, '.info/connected');
          onValue(connectedRef, (snap) => {
            if (snap.val() === true && myUID){
              const conRef = push(ref(db, `presence/${myUID}`)); // ã‚¿ãƒ–å˜ä½ã®æ¥ç¶š
              onDisconnect(conRef).remove();
              set(conRef, serverTimestamp());
            }
          });
          // å…¨æ¥ç¶šæ•°ï¼ˆ= åŒæ™‚ãƒ—ãƒ¬ã‚¤äººæ•°ã¨ã—ã¦æ‰±ã†ï¼‰
          if(onlineCountUnsub) onlineCountUnsub();
          onlineCountUnsub = onValue(ref(db, 'presence'), (snap) => {
            let total = 0;
            const val = snap.val() || {};
            for(const uid in val){ total += Object.keys(val[uid] || {}).length; } // ã‚¿ãƒ–æ•°ãƒ™ãƒ¼ã‚¹
            onlineEl.textContent = `åŒæ™‚ãƒ—ãƒ¬ã‚¤: ${total}`;
          });
        }

        // ç·ã‚¿ãƒƒãƒ—è³¼èª­
        function subscribeGlobalTaps(){
          if(tapsUnsub) tapsUnsub();
          tapsUnsub = onValue(ref(db, 'stats/tapCount'), (snap) => {
            const n = snap.val() || 0;
            tapsEl.textContent = `ç·ã‚¿ãƒƒãƒ—: ${n}`;
          });
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚«ã‚¦ãƒ³ã‚¿ã® transaction é–¢æ•°ã‚’ä¿æŒ
        window.__rtdbRunTransaction = (path, updater) => runTransaction(ref(db, path), updater);

      }catch(e){
        console.warn('Firebase åˆæœŸåŒ–ã«å¤±æ•—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã®ã¿å‹•ä½œï¼‰:', e);
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ç·ã‚¿ãƒƒãƒ— +1ï¼ˆFirebaseæ¥ç¶šã—ã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼‰
    async function incrementGlobalTapCount(){
      if(!window.__rtdbRunTransaction) return;
      try{
        await window.__rtdbRunTransaction('stats/tapCount', (n)=> (n||0) + 1);
      }catch(e){
        // å¤±æ•—ã—ã¦ã‚‚ã‚²ãƒ¼ãƒ ã¯ç¶šè¡Œ
      }
    }

    // åˆæœŸåŒ–
    updateUI();
    initFirebase();
  </script>
</body>
</html>
