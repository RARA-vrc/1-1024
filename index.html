<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>1/1024 チャレンジ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0c0c" />
  <style>
    :root{
      --bg:#0c0c0c; --fg:#f5f5f5; --muted:#bdbdbd;
      --card:#111; --border:#232323;
      --accent:#2dd4bf; --danger:#ef4444; --gold:#ffe08a;
      --glow: 0 0 40px rgba(45,212,191,.25), 0 0 80px rgba(45,212,191,.15);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;}
    .app{ min-height:100svh; display:grid; grid-template-rows:auto 1fr auto;
      gap:12px; padding: calc(env(safe-area-inset-top) + 12px) 14px calc(env(safe-area-inset-bottom) + 14px); user-select:none; touch-action:manipulation;}

    /* HUD */
    .hud{ display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center; font-variant-numeric:tabular-nums; }
    .title{ font-weight:800; letter-spacing:.02em; }
    .chip{ border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:14px; color:var(--muted); white-space:nowrap; }

    /* 中央表示 */
    .center{ display:grid; place-items:center; text-align:center; gap:10px; }
    .prob{ font-size: clamp(32px, 18vw, 124px); font-weight:900; letter-spacing:.02em; line-height:1.05; }
    .info{ color:var(--muted); font-size: clamp(13px, 4.5vw, 18px); }
    .goal{ color:var(--muted); font-size: clamp(12px, 4vw, 16px); }

    /* 巨大ボタン（テキストは「タップ」だけ） */
    .bigBtn{
      width:100%; height:min(60vh,60svh);
      border-radius:20px; border:2px solid var(--border);
      background:
        radial-gradient(180% 140% at 80% -10%, #252525 0%, #181818 40%, #131313 70%, #101010 100%);
      color:var(--fg); display:grid; place-items:center;
      font-size: clamp(28px, 8vw, 44px); font-weight:900; letter-spacing:.08em; text-transform: none;
      box-shadow: 0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
      transition: transform .02s ease, filter .08s ease;
      cursor:pointer;
    }
    .bigBtn:active{ transform: translateY(1px) scale(.998); filter:brightness(1.02); }

    /* 下部操作 */
    .footer{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
    .btn{ border:1px solid var(--border); background:#131313; color:var(--fg); padding:10px 14px; border-radius:12px; font-weight:700; font-size:14px; cursor:pointer; }
    .btn:active{ transform: translateY(1px); }

    /* フラッシュ演出 */
    .flash-ok{ animation: ok 160ms ease; }  .flash-ng{ animation: ng 180ms ease; }
    @keyframes ok{ 50%{ box-shadow:0 0 0 6px rgba(45,212,191,.22), 0 0 60px 10px rgba(45,212,191,.18);} }
    @keyframes ng{ 50%{ box-shadow:0 0 0 6px rgba(239,68,68,.22), 0 0 60px 10px rgba(239,68,68,.18);} }

    /* 勝利オーバーレイ（ゴージャス） */
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; }
    .overlay.show{ display:flex; }
    .backdrop{
      position:absolute; inset:0;
      background: radial-gradient(100% 130% at 50% 0%, rgba(0,0,0,.3), rgba(0,0,0,.85)),
                  conic-gradient(from 180deg at 50% 50%, #0b132b, #1c2541, #3a506b, #5bc0be, #a5ffd6, #0b132b);
      filter:saturate(1.2) brightness(.9);
    }
    .modal{
      position:relative; z-index:1;
      width:min(780px, 92vw);
      background: linear-gradient(180deg, rgba(16,16,16,.9), rgba(10,10,10,.9));
      border:1px solid rgba(255,255,255,.08);
      border-radius:20px; padding:18px;
      text-align:center; box-shadow: 0 40px 120px rgba(0,0,0,.6), 0 0 120px rgba(255,255,255,.08) inset;
    }
    .trophy{
      font-size: clamp(26px, 8vw, 36px);
      background: linear-gradient(90deg, #fff, #ffe08a, #fff);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 0 20px rgba(255,224,138,.15);
      letter-spacing:.02em; font-weight:900;
      animation: shimmer 4s linear infinite;
    }
    @keyframes shimmer{ 0%{filter:hue-rotate(0)} 100%{filter:hue-rotate(360deg)} }
    .stats{ color:var(--muted); margin:6px 0 10px; font-variant-numeric:tabular-nums; }
    .actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }

    /* 紙吹雪Canvas */
    canvas.fx{ position:absolute; inset:0; pointer-events:none; z-index:0; filter: drop-shadow(0 4px 10px rgba(0,0,0,.4)); }

    /* 小さな説明枠 */
    details{ margin-top:10px; border:1px solid var(--border); border-radius:12px; padding:10px 12px; color:var(--muted); }
    summary{ cursor:pointer; color:var(--fg); font-weight:700; }
    code{ background:#151515; padding:1px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- HUD -->
    <div class="hud">
      <div class="title">1/1024 チャレンジ</div>
      <div class="chip" id="globalTaps">総タップ: —</div>
      <div class="chip" id="online">同時プレイ: —</div>
    </div>

    <!-- 中央表示 -->
    <div class="center">
      <div class="prob" id="prob">1 / 2</div>
      <div class="info" id="info">連続成功: 0｜現在の一発確率: 1/2</div>
      <div class="goal" id="goal">ターゲット: 1/1024（メイン）</div>

      <button class="bigBtn" id="tryBtn" aria-label="タップ">タップ</button>
      <div class="info" id="best">自己ベスト: 1/2</div>
    </div>

    <!-- 下部操作 -->
    <div class="footer">
      <button class="btn" id="resetBtn">↻ リセット</button>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="soundBtn">🔊 効果音: ON</button>
        <button class="btn" id="vibeBtn">📳 バイブ: ON</button>
      </div>
    </div>
  </div>

  <!-- 1/1024 クリア用オーバーレイ -->
  <div class="overlay" id="winMain">
    <div class="backdrop"></div>
    <canvas class="fx" id="fxMain"></canvas>
    <div class="modal">
      <div class="trophy">CLEAR! 1/1024 達成</div>
      <div class="stats" id="winMainStats">総タップ: 0｜連続成功: 10</div>
      <div class="actions">
        <button class="btn" id="goBonus">🎯 続けて 1/4096 へ</button>
        <button class="btn" id="shareMain">🔗 結果を共有</button>
      </div>
      <details>
        <summary>判定の根拠</summary>
        <p>成功判定は <code>crypto.getRandomValues</code> で生成した一様32bit整数 <code>X</code> に対し「<code>X &lt; 2³¹</code>」を成功とする → 1/2 が厳密。連続10回成功で 1/1024 = (1/2)¹⁰。12回まで続ければ 1/4096 だ。</p>
      </details>
    </div>
  </div>

  <!-- 1/4096 クリア用オーバーレイ -->
  <div class="overlay" id="winUltra">
    <div class="backdrop"></div>
    <canvas class="fx" id="fxUltra"></canvas>
    <div class="modal">
      <div class="trophy">ULTRA CLEAR! 1/4096 達成</div>
      <div class="stats" id="winUltraStats">総タップ: 0｜連続成功: 12</div>
      <div class="actions">
        <button class="btn" id="again">↺ もう一度（最初から）</button>
        <button class="btn" id="shareUltra">🔗 結果を共有</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* ====== 定数 ====== */
    const TARGET_MAIN = 10;   // 1/1024
    const TARGET_BONUS = 12;  // 1/4096
    const BTN = document.getElementById('tryBtn');

    /* ====== 状態 ====== */
    let attempts = 0;
    let streak = 0;
    let bestPow = Number(localStorage.getItem('bestPow') || 1); // 到達した最大指数（= 最小確率の段） 1..12
    let soundOn = (localStorage.getItem('soundOn') ?? '1') === '1';
    let vibeOn  = (localStorage.getItem('vibeOn')  ?? '1') === '1';
    let inBonus = false; // メインを超えたら true

    /* ====== DOM ====== */
    const probEl  = document.getElementById('prob');
    const infoEl  = document.getElementById('info');
    const goalEl  = document.getElementById('goal');
    const bestEl  = document.getElementById('best');
    const tapsEl  = document.getElementById('globalTaps');
    const onlineEl= document.getElementById('online');

    const resetBtn= document.getElementById('resetBtn');
    const soundBtn= document.getElementById('soundBtn');
    const vibeBtn = document.getElementById('vibeBtn');

    const winMain = document.getElementById('winMain');
    const winMainStats = document.getElementById('winMainStats');
    const goBonus = document.getElementById('goBonus');
    const shareMain = document.getElementById('shareMain');
    const fxMain = document.getElementById('fxMain');

    const winUltra = document.getElementById('winUltra');
    const winUltraStats = document.getElementById('winUltraStats');
    const again = document.getElementById('again');
    const shareUltra = document.getElementById('shareUltra');
    const fxUltra = document.getElementById('fxUltra');

    /* ====== オーディオ ====== */
    let audioCtx = null;
    function ensureAudio(){ if(!soundOn) return; if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } catch(e){ audioCtx=null; } } }
    function beep(freq=880, ms=80, type='sine'){
      if(!soundOn || !audioCtx) return;
      const t0 = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = type; osc.frequency.setValueAtTime(freq, t0);
      osc.connect(g).connect(audioCtx.destination);
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.25, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);
      osc.start(t0); osc.stop(t0 + ms/1000 + 0.02);
    }

    /* ====== 乱数（厳密な1/2） ====== */
    function fairCoin(){
      if (window.crypto && crypto.getRandomValues){
        const a = new Uint32Array(1); crypto.getRandomValues(a);
        return (a[0] >>> 0) < 0x80000000; // 2^31
      }
      return Math.random() < 0.5; // フォールバック
    }

    /* ====== UI 更新 ====== */
    const pow2 = n => 2 ** n;
    function updateUI(){
      const target = inBonus ? TARGET_BONUS : TARGET_MAIN;
      const nextPow = Math.min(streak + 1, target);
      const denom = pow2(nextPow);
      probEl.textContent = `1 / ${denom}`;
      infoEl.textContent = `連続成功: ${streak}｜現在の一発確率: 1/${denom}`;
      goalEl.textContent = `ターゲット: ${inBonus ? '1/4096（ボーナス）' : '1/1024（メイン）'}`;
      bestEl.textContent = `自己ベスト: 1/${pow2(Math.max(bestPow,1))}`;
      soundBtn.textContent = `🔊 効果音: ${soundOn ? 'ON' : 'OFF'}`;
      vibeBtn.textContent  = `📳 バイブ: ${vibeOn ? 'ON' : 'OFF'}`;
      document.title = (streak>0?`連続${streak} ▶ `:'') + '1/1024 チャレンジ';
    }
    function flash(ok){ BTN.classList.remove('flash-ok','flash-ng'); void BTN.offsetWidth; BTN.classList.add(ok?'flash-ok':'flash-ng'); }

    /* ====== 1回判定 ====== */
    function judgeOnce(){
      attempts++;
      ensureAudio();
      incrementGlobalTapCount(); // グローバル総タップを+1（オンライン時のみ）

      const ok = fairCoin();
      if(ok){
        streak++;
        if(vibeOn && navigator.vibrate) navigator.vibrate(20);
        beep(900 + streak*12, 70, 'triangle');
        flash(true);

        if(!inBonus && streak>=TARGET_MAIN){
          bestPow = Math.max(bestPow, TARGET_MAIN);
          localStorage.setItem('bestPow', String(bestPow));
          showWinMain();
          updateUI();
          return;
        }
        if(inBonus && streak>=TARGET_BONUS){
          bestPow = Math.max(bestPow, TARGET_BONUS);
          localStorage.setItem('bestPow', String(bestPow));
          showWinUltra();
          updateUI();
          return;
        }
      }else{
        if(vibeOn && navigator.vibrate) navigator.vibrate([12,35,90]);
        beep(180, 120, 'sawtooth');
        flash(false);
        streak = 0;
      }
      bestPow = Math.max(bestPow, Math.min(streak, TARGET_BONUS));
      localStorage.setItem('bestPow', String(bestPow));
      updateUI();
    }

    /* ====== 勝利演出 ====== */
    function confetti(canvas, durationMs=4200, count=220){
      const ctx = canvas.getContext('2d');
      const {width:W, height:H} = canvas.getBoundingClientRect();
      canvas.width = W * devicePixelRatio; canvas.height = H * devicePixelRatio; ctx.scale(devicePixelRatio, devicePixelRatio);
      const pieces = Array.from({length:count}, () => ({
        x: Math.random()*W, y: -20 - Math.random()*H,
        w: 6+Math.random()*7, h: 10+Math.random()*14,
        vy: 2+Math.random()*3, vx:(Math.random()-.5)*1.2, rot:Math.random()*Math.PI, vr:(Math.random()-.5)*0.2,
      }));
      const colors = ['#FF6B6B','#FFD93D','#6BCB77','#4D96FF','#B892FF','#F6C177','#2DD4BF','#E879F9'];
      let start = performance.now();
      function frame(t){
        const elapsed = t - start;
        ctx.clearRect(0,0,W,H);
        for(const p of pieces){
          p.x += p.vx; p.y += p.vy; p.rot += p.vr;
          if(p.y > H+40) { p.y = -20; p.x = Math.random()*W; }
          ctx.save();
          ctx.translate(p.x,p.y); ctx.rotate(p.rot);
          ctx.fillStyle = colors[(p.x^p.y + p.w|0) % colors.length];
          ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          ctx.restore();
        }
        if(elapsed < durationMs) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }
    function showWinMain(){
      winMainStats.textContent = `総タップ: ${attempts}｜連続成功: ${streak}`;
      winMain.classList.add('show');
      confetti(fxMain);
    }
    function showWinUltra(){
      winUltraStats.textContent = `総タップ: ${attempts}｜連続成功: ${streak}`;
      winUltra.classList.add('show');
      confetti(fxUltra, 5200, 300);
    }

    /* ====== イベント設定 ====== */
    BTN.addEventListener('pointerdown', e => { e.preventDefault(); judgeOnce(); }, {passive:false});
    resetBtn.addEventListener('click', ()=>{ attempts=0; streak=0; inBonus=false; updateUI(); });
    soundBtn.addEventListener('click', ()=>{ soundOn=!soundOn; localStorage.setItem('soundOn', soundOn?'1':'0'); if(soundOn) ensureAudio(); updateUI(); });
    vibeBtn.addEventListener('click', ()=>{ vibeOn=!vibeOn; localStorage.setItem('vibeOn', vibeOn?'1':'0'); updateUI(); });

    goBonus.addEventListener('click', ()=>{ winMain.classList.remove('show'); inBonus=true; updateUI(); });
    again.addEventListener('click', ()=>{ winUltra.classList.remove('show'); attempts=0; streak=0; inBonus=false; updateUI(); });

    async function shareText(text){
      try{
        if(navigator.share){ await navigator.share({text, url: location.href}); }
        else{ await navigator.clipboard.writeText(text + ' ' + location.href); }
      }catch(_){ /* noop */ }
    }
    shareMain.addEventListener('click', ()=> shareText(`1/1024 クリア！連続${streak}回`));
    shareUltra.addEventListener('click', ()=> shareText(`1/4096 クリア！連続${streak}回`));

    /* ====== Firebase（CDN ESM, 匿名Auth + Realtime Database） ====== */
    let db=null, myUID=null, onlineCountUnsub=null, tapsUnsub=null;

    async function initFirebase(){
      // 自前プロジェクトの設定をここに貼る（Firebaseコンソール > ウェブアプリの設定）
      const firebaseConfig = {
        // TODO: ここに自分の Firebase 設定を書く（apiKey, authDomain, databaseURL, projectId, appId など）
        // 例:
        // apiKey: "AIzaSy....",
        // authDomain: "yourapp.firebaseapp.com",
        // databaseURL: "https://yourapp-default-rtdb.asia-southeast1.firebasedatabase.app",
        // projectId: "yourapp",
        // appId: "1:1234567890:web:abcd..."
      };
      // 設定未入力ならオンライン機能はスキップ
      if(!firebaseConfig || !firebaseConfig.apiKey){ return; }

      try{
        const [{ initializeApp }, { getAuth, signInAnonymously, onAuthStateChanged }, { getDatabase, ref, onValue, push, set, onDisconnect, serverTimestamp, runTransaction }] =
          await Promise.all([
            import('https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js'),
            import('https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js'),
            import('https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js'),
          ]);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        db = getDatabase(app);

        // 匿名サインイン
        await signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
          if(!user) return;
          myUID = user.uid;
          setupPresence();
          subscribeGlobalTaps();
        });

        // presence 設定
        function setupPresence(){
          const connectedRef = ref(db, '.info/connected');
          onValue(connectedRef, (snap) => {
            if (snap.val() === true && myUID){
              const conRef = push(ref(db, `presence/${myUID}`)); // タブ単位の接続
              onDisconnect(conRef).remove();
              set(conRef, serverTimestamp());
            }
          });
          // 全接続数（= 同時プレイ人数として扱う）
          if(onlineCountUnsub) onlineCountUnsub();
          onlineCountUnsub = onValue(ref(db, 'presence'), (snap) => {
            let total = 0;
            const val = snap.val() || {};
            for(const uid in val){ total += Object.keys(val[uid] || {}).length; } // タブ数ベース
            onlineEl.textContent = `同時プレイ: ${total}`;
          });
        }

        // 総タップ購読
        function subscribeGlobalTaps(){
          if(tapsUnsub) tapsUnsub();
          tapsUnsub = onValue(ref(db, 'stats/tapCount'), (snap) => {
            const n = snap.val() || 0;
            tapsEl.textContent = `総タップ: ${n}`;
          });
        }

        // グローバルカウンタの transaction 関数を保持
        window.__rtdbRunTransaction = (path, updater) => runTransaction(ref(db, path), updater);

      }catch(e){
        console.warn('Firebase 初期化に失敗（オフライン機能のみ動作）:', e);
      }
    }

    // グローバル総タップ +1（Firebase接続していなければ何もしない）
    async function incrementGlobalTapCount(){
      if(!window.__rtdbRunTransaction) return;
      try{
        await window.__rtdbRunTransaction('stats/tapCount', (n)=> (n||0) + 1);
      }catch(e){
        // 失敗してもゲームは続行
      }
    }

    // 初期化
    updateUI();
    initFirebase();
  </script>
</body>
</html>
