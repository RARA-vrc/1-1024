<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>1/1024</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0c0c" />
  <style>
    :root{
      --bg:#0c0c0c; --fg:#f5f5f5; --muted:#bdbdbd;
      --border:#232323;
      --accent:#2dd4bf; --danger:#ef4444; --gold:#ffe08a;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
    }
    .app{ min-height:100svh; display:grid; grid-template-rows:auto auto 1fr auto;
      gap:10px; padding: calc(env(safe-area-inset-top) + 12px) 14px calc(env(safe-area-inset-bottom) + 14px);
      user-select:none; touch-action:manipulation; }

    .hud{ display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center; }
    .title{ font-weight:800; }
    .chip{ border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:14px; color:var(--muted); white-space:nowrap; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }

    .center{ display:grid; place-items:center; text-align:center; gap:10px; }
    .prob{ font-size: clamp(32px, 18vw, 124px); font-weight:900; }
    .info,.goal{ color:var(--muted); }

    .bigBtn{
      width:100%; height:min(60vh,60svh);
      border-radius:20px; border:2px solid var(--border);
      background: radial-gradient(180% 140% at 80% -10%, #252525 0%, #181818 40%, #131313 70%, #101010 100%);
      color:var(--fg); display:grid; place-items:center;
      font-size: clamp(28px, 8vw, 44px); font-weight:900;
      cursor:pointer;
    }
    .bigBtn:active{ transform:translateY(1px) scale(.998); filter:brightness(1.02); }

    .footer{ display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap; }
    .btn{ border:1px solid var(--border); background:#131313; color:var(--fg);
      padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; }

    .flash-ok{ animation: ok 160ms ease; }  .flash-ng{ animation: ng 180ms ease; }
    @keyframes ok{ 50%{ box-shadow:0 0 0 6px rgba(45,212,191,.22), 0 0 60px 10px rgba(45,212,191,.18);} }
    @keyframes ng{ 50%{ box-shadow:0 0 0 6px rgba(239,68,68,.22), 0 0 60px 10px rgba(239,68,68,.18);} }

    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; }
    .overlay.show{ display:flex; }
    .backdrop{ position:absolute; inset:0;
      background: radial-gradient(100% 130% at 50% 0%, rgba(0,0,0,.3), rgba(0,0,0,.85)),
                  conic-gradient(from 180deg at 50% 50%, #0b132b, #1c2541, #3a506b, #5bc0be, #a5ffd6, #0b132b); }
    .modal{ position:relative; z-index:1; width:min(780px, 92vw); background:rgba(10,10,10,.9);
      border:1px solid rgba(255,255,255,.08); border-radius:20px; padding:18px; text-align:center; }
    .trophy{ font-size:clamp(26px, 8vw, 36px); font-weight:900; background:linear-gradient(90deg,#fff,#ffe08a,#fff);
      -webkit-background-clip:text; color:transparent; }
    canvas.fx{ position:absolute; inset:0; pointer-events:none; z-index:0; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="hud">
      <div class="title">1/1024</div>
      <div class="chip" id="globalTaps">総タップ: —</div>
      <div class="chip" id="online">同時プレイ: —</div>
    </div>
    <div class="chips">
      <div class="chip" id="localAttempts">試行: 0</div>
      <div class="chip" id="localFails">失敗: 0</div>
      <div class="chip" id="localClear1024">1/1024達成: 0</div>
      <div class="chip" id="localClear4096">1/4096達成: 0</div>
      <div class="chip" id="bestChip">自己ベスト: 1/2</div>
    </div>
    <div class="center">
      <div class="prob" id="prob">1 / 2</div>
      <div class="info" id="info">連続成功: 0｜現在の一発確率: 1/2</div>
      <div class="goal" id="goal">ターゲット: 1/1024（メイン）</div>
      <button class="bigBtn" id="tryBtn">タップ</button>
    </div>
    <div class="footer">
      <button class="btn" id="resetBtn">↻ リセット</button>
      <div>
        <button class="btn" id="soundBtn">🔊 効果音: ON</button>
        <button class="btn" id="vibeBtn">📳 バイブ: ON</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="winMain">
    <div class="backdrop"></div><canvas class="fx" id="fxMain"></canvas>
    <div class="modal">
      <div class="trophy">CLEAR! 1/1024 達成</div>
      <div class="stats" id="winMainStats"></div>
      <button class="btn" id="goBonus">🎯 続けて 1/4096 へ</button>
    </div>
  </div>
  <div class="overlay" id="winUltra">
    <div class="backdrop"></div><canvas class="fx" id="fxUltra"></canvas>
    <div class="modal">
      <div class="trophy">ULTRA CLEAR! 1/4096 達成</div>
      <div class="stats" id="winUltraStats"></div>
      <button class="btn" id="again">↺ もう一度</button>
    </div>
  </div>

  <script type="module">
    const TARGET_MAIN=10, TARGET_BONUS=12;
    let attempts=0, streak=0, inBonus=false;
    let localAttempts=+localStorage.localAttempts||0,
        localFails=+localStorage.localFails||0,
        localClear1024=+localStorage.localClear1024||0,
        localClear4096=+localStorage.localClear4096||0,
        bestPow=+localStorage.bestPow||1;
    let soundOn=(localStorage.soundOn??'1')==='1',
        vibeOn=(localStorage.vibeOn??'1')==='1';

    const probEl=document.getElementById('prob'),
          infoEl=document.getElementById('info'),
          goalEl=document.getElementById('goal'),
          localAttemptsEl=document.getElementById('localAttempts'),
          localFailsEl=document.getElementById('localFails'),
          localClear1024El=document.getElementById('localClear1024'),
          localClear4096El=document.getElementById('localClear4096'),
          bestChipEl=document.getElementById('bestChip'),
          globalTapsEl=document.getElementById('globalTaps'),
          onlineEl=document.getElementById('online');

    function updateUI(){
      const t=inBonus?TARGET_BONUS:TARGET_MAIN;
      const next=Math.min(streak+1,t), denom=2**next;
      probEl.textContent=`1 / ${denom}`;
      infoEl.textContent=`連続成功: ${streak}｜現在の一発確率: 1/${denom}`;
      goalEl.textContent=`ターゲット: ${inBonus?'1/4096':'1/1024'}`;
      localAttemptsEl.textContent=`試行: ${localAttempts}`;
      localFailsEl.textContent=`失敗: ${localFails}`;
      localClear1024El.textContent=`1/1024達成: ${localClear1024}`;
      localClear4096El.textContent=`1/4096達成: ${localClear4096}`;
      bestChipEl.textContent=`自己ベスト: 1/${2**bestPow}`;
    }

    function fairCoin(){const a=new Uint32Array(1);crypto.getRandomValues(a);return a[0]<0x80000000;}
    function judge(){
      attempts++; localAttempts++; localStorage.localAttempts=localAttempts;
      const ok=fairCoin();
      if(ok){
        streak++;
        if(!inBonus&&streak>=TARGET_MAIN){localClear1024++;localStorage.localClear1024=localClear1024;bestPow=Math.max(bestPow,TARGET_MAIN);localStorage.bestPow=bestPow;document.getElementById('winMain').classList.add('show');}
        if(inBonus&&streak>=TARGET_BONUS){localClear4096++;localStorage.localClear4096=localClear4096;bestPow=Math.max(bestPow,TARGET_BONUS);localStorage.bestPow=bestPow;document.getElementById('winUltra').classList.add('show');}
      }else{streak=0;localFails++;localStorage.localFails=localFails;}
      bestPow=Math.max(bestPow,Math.min(streak,TARGET_BONUS));
      localStorage.bestPow=bestPow;updateUI();incrementGlobalTap();
    }

    document.getElementById('tryBtn').onclick=()=>judge();
    document.getElementById('resetBtn').onclick=()=>{attempts=0;streak=0;inBonus=false;updateUI();};
    document.getElementById('goBonus').onclick=()=>{document.getElementById('winMain').classList.remove('show');inBonus=true;};
    document.getElementById('again').onclick=()=>{document.getElementById('winUltra').classList.remove('show');attempts=0;streak=0;inBonus=false;updateUI();};

    // === Firebase ===
    let db,myUID;
    async function initFirebase(){
      const firebaseConfig={
        apiKey:"AIzaSyDtdpDv3rduha4z6OGkQrRYCMNDuKcVBLk",
        authDomain:"project-4739003489934004266.firebaseapp.com",
        projectId:"project-4739003489934004266",
        storageBucket:"project-4739003489934004266.firebasestorage.app",
        messagingSenderId:"599571252669",
        appId:"1:599571252669:web:7e321aacd113b5df4dfed4",
        measurementId:"G-VW1NRCTKWR",
        databaseURL:"https://project-4739003489934004266-default-rtdb.asia-southeast1.firebasedatabase.app"
      };
      const [{initializeApp},{getAuth,signInAnonymously,onAuthStateChanged},{getDatabase,ref,onValue,push,set,onDisconnect,serverTimestamp,runTransaction}] =
        await Promise.all([
          import('https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js'),
          import('https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js'),
          import('https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js')
        ]);
      const app=initializeApp(firebaseConfig);
      db=getDatabase(app);
      const auth=getAuth(app);
      await signInAnonymously(auth);
      onAuthStateChanged(auth,(user)=>{
        if(!user)return; myUID=user.uid; setupPresence(ref,onValue,push,set,onDisconnect,serverTimestamp); subscribeTaps(ref,onValue);
      });
      window.__rtdbRunTransaction=(p,u)=>runTransaction(ref(db,p),u);
    }

    function setupPresence(ref,onValue,push,set,onDisconnect,serverTimestamp){
      const cRef=ref(db,'.info/connected');
      onValue(cRef,(s)=>{
        if(s.val()===true&&myUID){
          const con=push(ref(db,'presence/'+myUID));
          onDisconnect(con).remove(); set(con,serverTimestamp());
        }
      });
      onValue(ref(db,'presence'),(snap)=>{
        let unique=0;const v=snap.val()||{};
        for(const uid in v){if(Object.keys(v[uid]||{}).length>0)unique++;}
        onlineEl.textContent=`同時プレイ: ${unique}`;
      });
    }
    function subscribeTaps(ref,onValue){
      onValue(ref(db,'stats/tapCount'),(snap)=>{
        globalTapsEl.textContent=`総タップ: ${snap.val()||0}`;
      });
    }
    async function incrementGlobalTap(){
      if(!window.__rtdbRunTransaction)return;
      await window.__rtdbRunTransaction('stats/tapCount',(n)=>(n||0)+1);
    }

    updateUI(); initFirebase();
  </script>
</body>
</html>
